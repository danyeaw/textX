<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Igor DejanoviÄ‡">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Entity - textX</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../style.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-68681917-1', 'igordejanovic.net');
            ga('send', 'pageview');
        </script>
        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">textX</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../grammar/">Grammar</a>
</li>

                        
                            
<li >
    <a href="../../metamodel/">Meta-model</a>
</li>

                        
                            
<li >
    <a href="../../model/">Model</a>
</li>

                        
                            
<li >
    <a href="../../visualization/">Visualization</a>
</li>

                        
                            
<li >
    <a href="../../error_handling/">Error handling</a>
</li>

                        
                            
<li >
    <a href="../../debugging/">Debugging</a>
</li>

                        
                            
<li >
    <a href="../../textx_command/">textx command</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../hello_world/">Hello World</a>
</li>

                        
                            
<li >
    <a href="../robot/">Robot</a>
</li>

                        
                            
<li class="active">
    <a href="./">Entity</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/discuss/">Discuss</a>
</li>

                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/license/">License</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../robot/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../about/discuss/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/igordejanovic/textX">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#entity-tutorial">Entity tutorial</a></li>
        
            <li><a href="#entity-language">Entity language</a></li>
        
            <li><a href="#the-grammar">The grammar</a></li>
        
            <li><a href="#generating-source-code">Generating source code</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="entity-tutorial">Entity tutorial</h1>
<p>A tutorial for building ER-like language and generating Java code.</p>
<hr />
<h2 id="entity-language">Entity language</h2>
<p>In this example we will see how to make a simple language form data modeling.
We will use this language to generate Java source code (POJO classes).</p>
<p>Our main concept will be <code>Entity</code>. Each entity will have one or more
<code>properties</code>.  Each property is defined by its <code>name</code> and its <code>type</code>.</p>
<p>Let's sketch out a model on our language.</p>
<pre><code>entity Person {
  name : string       
  address: Address   
  age: integer      
}

entity Address {
  street : string
  city : string
  country : string
}
</code></pre>
<h2 id="the-grammar">The grammar</h2>
<p>In our example we see that each entity starts with a keyword <code>entity</code>. After
that, we have a name that is identifier and open brace.
Inside braces we have properties. In textX this is written as:</p>
<pre><code>Entity:
    'entity' name=ID '{'
        properties+=Property
    '}'
;
</code></pre>
<p>We can see that the <code>Entity</code> rule references <code>Property</code> rule from the
assignment. Each property is defined by the <code>name</code>, semi-colon (<code>:</code>) and the
name of the type. This can be written as:</p>
<pre><code>Property:
    name=ID ':' type=ID
;
</code></pre>
<p>Now, grammar like this will parse a single <code>Entity</code>. We haven't stated yet that
that our model consists of many <code>Entity</code> instances.</p>
<p>Let's specify that. We are introducing rule for the whole model which states
that each entity model contains one or more <code>entities</code>.</p>
<pre><code>EntityModel:
    entities+=Entity
;
</code></pre>
<p>This rule must be first rule in the textX grammar file. First rule is always
considered a <code>root rule</code>.</p>
<p>This grammar will parse the example model from the beginning.</p>
<p>Meta-model now looks like this:</p>
<p><img alt="Entity metamodel 1" src="../entity/entity1.tx.dot.png" /></p>
<p>While the example Person model looks like this:</p>
<p><img alt="Person model 1" src="../entity/person1.ent.dot.png" /></p>
<p>What you see on the model diagram are actual Python objects.
It looks good, but it would be even better if a reference to <code>Address</code> from
properties would be actual Python reference, not just a value of <code>str</code> type.</p>
<p>This resolving of object names to references can be done automatically by textX.
To do so we shall change our <code>Property</code> rule to be:</p>
<pre><code>Property:
    name=ID ':' type=[Entity]
;
</code></pre>
<p>Now, we state that type is a reference (we are using <code>[]</code>) to object of class
<code>Entity</code>. This instructs textX to search for the name of <code>Entity</code> after the 
colon and when found to resolve it to an <code>Entity</code> instance with the same name
defined elsewhere in the model.</p>
<p>But, we have problem now. There are no entities called <code>string</code> and <code>integer</code>
which we use for several properties in our model. To remedy this, we must 
introduce dummy entities with those names and change <code>properties</code> attribute
assignment to be <code>zero or more</code> (<code>*=</code>) since our dummy entities will have no
attributes.</p>
<p>Although, this solution is possible it wouldn't be elegant at all. So let's
do something better. First, let's introduce an abstract concept called <code>Type</code>
which will be generalization of simple types (like <code>integer</code> and <code>string</code>) and
complex types (like <code>Entity</code>).</p>
<pre><code>Type:
  SimpleType | Entity 
;
</code></pre>
<p>This is called abstract rule, and it means that <code>Type</code> is either <code>SimpleType</code>
or <code>Entity</code> instance. <code>Type</code> class from the meta-model will never be
instantiated.</p>
<p>Now, we shall change our <code>Property</code> rule definition:</p>
<pre><code>Property:
    name=ID ':' type=[Type]
;
</code></pre>
<p>And, at the end, there must be a way to specify our simple types. Let's do that
at the beginning of our model.</p>
<pre><code>EntityModel:
    simple_types *= SimpleType
    entities += Entity
;
</code></pre>
<p>And the definition of <code>SimpleType</code> would be:</p>
<pre><code>SimpleType:
  'type' name=ID
;
</code></pre>
<p>So, simple types are defined at the beginning of the model using keyword <code>type</code>
after which we specify the name of the type.</p>
<p>Our person model will begin now with:</p>
<pre><code>type string
type integer

entity Person {
...
</code></pre>
<p>Meta-model now looks like this:</p>
<p><img alt="Entity metamodel 2" src="../entity/entity.tx.dot.png" /></p>
<p>While the example Person model looks like this:</p>
<p><img alt="Person model 2" src="../entity/person.ent.dot.png" /></p>
<p>But, we can make this language even better. We can define some built-in simple
types so that the user does not need to specify them for every model. This has
to be done from python during meta-model instantiation. We can instantiate
<code>integer</code> and <code>string</code> simple types and introduce them in every model
programmatically.</p>
<p>First problem is how to instantiate <code>SimpleType</code> class. textX will dynamically
create Python class for each rule from the grammar but we do not have access
to these classes in advance.</p>
<p>Luckily, textX offers a way to override dynamically created classes with user
supplied ones. So, we can create our class <code>SimpleType</code> and register that class
during meta-model instantiation together with two its instances (<code>integer</code> and
<code>string</code>).</p>
<pre><code>class SimpleType(object):
  def __init__(self, parent, name):  # remember to include parent param.
    self.parent = parent
    self.name = name
</code></pre>
<p>Now, we can make a dict of builtin objects.</p>
<p>myobjs =  {
    'integer': SimpleType(None, 'integer')
    'string': SimpleType(None, 'string')
  }</p>
<p>And register our custom class and two builtins on the meta-model:</p>
<pre><code>meta = metamodel_from_file('entity.tx', 
                           classes=[SimpleType],
                           builtins=myobjs)
</code></pre>
<p>Now, if we use <code>meta</code> to load our models we do not have to specify <code>integer</code> and
<code>string</code> types. Furthermore, each instance of <code>SimpleType</code> will be an instance
of our <code>SimpleType</code> class.</p>
<p>We, can use these custom classes support to implement any custom behaviour in
our object graph.</p>
<h2 id="generating-source-code">Generating source code</h2>
<p>textX doesn't impose any specific library or process for source code generation.
You can use anything you like. From <code>print</code> function to template engines.</p>
<p>I highly recommend you to use some of well established <a href="https://en.wikipedia.org/wiki/Template_processor">template
engines</a>.</p>
<p>Here, we will see how to use <a href="http://jinja.pocoo.org/">Jinja2 template engine</a>
to generate Java source code from our entity models.</p>
<p>First, install jinja2 with pip:</p>
<pre><code>$ pip install Jinja2
</code></pre>
<p>Now, for each entity in our model we will render one Java file with getters and
setters rendered for each property.</p>
<p>Let's write Jinja2 template (file <code>java.template</code>):</p>
<pre><code>// Autogenerated from java.template file
class {{entity.name}} {

  {% for property in entity.properties %}
  protected {{property.type|javatype}} {{property.name}};
  {% endfor %}

  {% for property in entity.properties %}
  public {{property.type|javatype}} get{{property.name|capitalize}}(){
    return this.{{property.name}};
  }

  public void set{{property.name|capitalize}}({{property.type|javatype}} new_value){
    this.{{property.name}} = new_value;
  }

  {% endfor %}
}
</code></pre>
<p>Templates have static parts that will be rendered as is, and variable parts 
whose content will came from the model. Variable parts are written inside
<code>{{}}</code>. For example <code>{{entity.name}}</code> from the second line is the name of
the current entity.</p>
<p>The logic of rendering is controlled by <code>tags</code> written in <code>{%...%}</code> (e.g. loops,
conditions).</p>
<p>We can see that this template will render a warning that this is auto-generated
code (it is always good to do that!). Than it will render Java class named after
the current entity and than, for each property in the entity (please note that
we are using textX model so all attribute names come from the textX grammar) we
are rendering Java attribute and after that we are rendering getters and
setters.</p>
<p>You could notice that for rendering proper Java types we are using <code>|javatype</code>
expression. This is called <code>filter</code> in Jinja2. It works similar to <code>unix</code> pipes.
You have an object and you pass it to some filter. Filter will transform given
object to some other object. In this case <code>javatype</code> is a simple python function
that will transform our types (<code>integer</code> and <code>string</code>) to proper Java types
(<code>int</code> and <code>String</code>).</p>
<p>Now, let's see how can we put this all together. We need to initialize Jinja2
engine, instantiate our meta-model, load our model and than iterate over 
entities from our model and generate Java file for each entity:</p>
<pre><code>from os import mkdir
from os.path import exists, dirname, join
import jinja2
from textx.metamodel import metamodel_from_file

this_folder = dirname(__file__)


class SimpleType(object):
    def __init__(self, parent, name):
        self.parent = parent
        self.name = name

    def __str__(self):
        return self.name


def get_entity_mm():
    """
    Builds and returns a meta-model for Entity language.
    """
    type_builtins = {
            'integer': SimpleType(None, 'integer'),
            'string': SimpleType(None, 'string')
    }
    entity_mm = metamodel_from_file(join(this_folder, 'entity.tx'),
                                    classes=[SimpleType],
                                    builtins=type_builtins)

    return entity_mm


def main(debug=False):

    # Instantiate Entity meta-model
    entity_mm = get_entity_mm()

    def javatype(s):
        """
        Maps type names from SimpleType to Java.
        """
        return {
                'integer': 'int',
                'string': 'String'
        }.get(s.name, s.name)

    # Create output folder
    srcgen_folder = join(this_folder, 'srcgen')
    if not exists(srcgen_folder):
        mkdir(srcgen_folder)

    # Initialize template engine.
    jinja_env = jinja2.Environment(
        loader=jinja2.FileSystemLoader(this_folder),
        trim_blocks=True,
        lstrip_blocks=True)

    # Register filter for mapping Entity type names to Java type names.
    jinja_env.filters['javatype'] = javatype

    # Load Java template
    template = jinja_env.get_template('java.template')

    # Build Person model from person.ent file
    person_model = entity_mm.model_from_file(join(this_folder, 'person.ent'))

    # Generate Java code
    for entity in person_model.entities:
        # For each entity generate java file
        with open(join(srcgen_folder,
                      "%s.java" % entity.name.capitalize()), 'w') as f:
            f.write(template.render(entity=entity))


if __name__ == "__main__":
    main()
</code></pre>
<p>And the generated code will look like this:</p>
<pre><code>// Autogenerated from java.template file
class Person {

  protected String name;
  protected Address address;
  protected int age;

  public String getName(){
    return this.name;
  }

  public void setName(String new_value){
    this.name = new_value;
  }

  public Address getAddress(){
    return this.address;
  }

  public void setAddress(Address new_value){
    this.address = new_value;
  }

  public int getAge(){
    return this.age;
  }

  public void setAge(int new_value){
    this.age = new_value;
  }

}
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code from this tutorial can be found in the
<a href="https://github.com/igordejanovic/textX/tree/master/examples/Entity">examples/Entity</a>
folder.</p>
</div></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
